rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    // A user's own document in roles_admin can be read by them to verify their admin status.
    match /roles_admin/{userId} {
      allow get: if isOwner(userId);
      // Only other admins can see or modify the admin list.
      allow list, write, delete: if isAdmin();
    }

    // --- User Profiles (/users) ---
    match /users/{userId} {
      // An admin can get any user profile, a user can get their own.
      allow get: if isAdmin() || isOwner(userId);
      
      // Only admins can list all users (for reports).
      allow list: if isAdmin();
      
      // A user can create their own profile.
      allow create: if isOwner(userId) 
                    && request.resource.data.uid == userId;

      // A user can update their own profile, but cannot change their role.
      // An admin can update any profile (including changing roles).
      allow update: if isOwner(userId) && request.resource.data.role == resource.data.role || isAdmin();

      // Only admins can delete user profiles.
      allow delete: if isAdmin();
    }

    // --- Attendance Data (/attendanceSessions) ---
    match /attendanceSessions/{sessionId} {
      // Any signed-in user can view session details.
      allow get, list: if isSignedIn();
      
      // Only admins can create, update, or delete sessions.
      allow create, update, delete: if isAdmin();

      // --- Attendance Records (subcollection) ---
      match /attendanceRecords/{recordId} {
        // A user can get their own attendance record. Admins can get any.
        allow get: if isOwner(recordId) || isAdmin();
        
        // Only admins can list attendance records (for reports).
        allow list: if isAdmin();

        // A user can create their own attendance record (ID must match their UID).
        // This prevents one user from marking attendance for another.
        allow create: if isOwner(recordId) 
                      && request.resource.data.userId == request.auth.uid;
        
        // Only admins can modify or delete attendance records.
        allow update, delete: if isAdmin();
      }
    }
  }
}
